apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab
  labels:
    app: gitlab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitlab
  template:
    metadata:
      labels:
        app: gitlab
    spec:
      hostAliases:
        - ip: 127.0.0.1
          hostnames:
            - gitlab
            - gocd
      volumes:
        - name: gitlabcert
          hostPath:
            type: DirectoryOrCreate
            path: /disk1/gitlab/cert
        - name: gitlabopt
          hostPath:
            type: DirectoryOrCreate
            path: /disk1/gitlab/gitlab
        - name: gitlabconf
          hostPath:
            type: DirectoryOrCreate
            path: /disk1/gitlab/gitlab-conf
        - name: gitlablog
          hostPath:
            type: DirectoryOrCreate
            path: /disk1/gitlab/gitlab-log
        - name: docker-sock
          hostPath:
            path: /var/run/docker.sock
        - name: runner-config
          hostPath:
            path: /disk1/gitlab/runner
            type: DirectoryOrCreate
        - name: gitlab-rb
          configMap:
            name: gitlab-rb
            items:
              - key: gitlab.rb
                path: gitlab.rb
        - name: gitlab-ssl-script
          configMap:
            name: gitlab-ssl-script
            defaultMode: 0744
            items:
              - key: ssl.sh
                path: ssl.sh
        - name: gocd
          hostPath:
            type: DirectoryOrCreate
            path: /disk1/gocd/
        - name: gocdcert
          hostPath:
            type: DirectoryOrCreate
            path: /disk1/gitlab/cert
        - name: nginx-config
          configMap:
            name: nginx-config
            items:
              - key: nginx.conf
                path: nginx.conf
      initContainers:
        #- name: openssl-ca
        #  image: alpine/openssl
        #  volumeMounts:
        #    - mountPath: /cert
        #      name: gitlabcert
        #    - mountPath: /ssl.sh
        #      name: gitlab-ssl-script
        #      subPath: ssl.sh
        #  command:
        #    - sh
        #    - /ssl.sh
        #    - CA
        - name: openssl-gitlab
          image: alpine/openssl
          volumeMounts:
            - mountPath: /cert
              name: gitlabcert
            - mountPath: /ssl.sh
              name: gitlab-ssl-script
              subPath: ssl.sh
          command:
            - sh
            - /ssl.sh
            - gitlab
        - name: openssl-gocd
          image: alpine/openssl
          volumeMounts:
            - mountPath: /cert
              name: gocdcert
            - mountPath: /ssl.sh
              name: gitlab-ssl-script
              subPath: ssl.sh
          command:
            - sh
            - /ssl.sh
            - gocd
        - name: directory
          image: debian:latest
          volumeMounts:
            - mountPath: /godata
              name: gocd
          command:
            - chown
            - "-R"
            - "1000:1000"
            - "/godata"
      containers:
        - name: gitlab
          image: gitlab/gitlab-ee:latest
          volumeMounts:
            - mountPath: /etc/gitlab
              name: gitlabconf
            - mountPath: /var/log/gitlab
              name: gitlablog
            - mountPath: /etc/gitlab/cert
              name: gitlabcert
            - mountPath: /var/opt/gitlab
              name: gitlabopt
            - mountPath: /etc/gitlab/gitlab.rb
              name: gitlab-rb
              subPath: gitlab.rb
          ports:
            - containerPort: 22
            - containerPort: 8181

        - name: runner
          image: gitlab/gitlab-runner:latest
          volumeMounts:
            - mountPath: /etc/gitlab-runner
              name: runner-config
            - mountPath: /var/run/docker.sock
              name: docker-sock

        - name: nginx
          image: nginx
          ports:
            - containerPort: 443
          volumeMounts:
            - mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
              name: nginx-config
            - mountPath: /cert
              name: gitlabcert

        - name: gocd
          image: gocd/gocd-server:v22.3.0
          volumeMounts:
            - mountPath: /godata
              name: gocd
            - mountPath: /cert
              name: gitlabcert
          env:
            - name: GOCD_PLUGIN_INSTALL_a-plugin
              value: https://github.com/gocd-contrib/gitlab-oauth-authorization-plugin/releases/download/v2.1.0-145/gitlab-oauth-authorization-plugin-2.1.0-145.jar
            - name: GOCD_PLUGIN_INSTALL_b-plugin
              value: https://github.com/gocd-contrib/github-oauth-authorization-plugin/releases/download/v3.3.1-211/github-oauth-authorization-plugin-3.3.1-211.jar
          ports:
            - containerPort: 8153
